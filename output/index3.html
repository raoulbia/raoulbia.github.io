<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>code snippets etc.</title>
    <link rel="shortcut icon" type="image/png" href="./favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico">
    <link rel="stylesheet" href="./theme/css/screen.css" type="text/css" />
    <link rel="stylesheet" href="./theme/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="./theme/css/print.css" type="text/css" media="print" />
    <meta name="generator" content="Pelican" />
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href=".">Home</a></li>
                <li><a href="https://github.com/raoulbia">GitHub</a></li>
                <li><a href="./archives">Archives</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href=".">code snippets etc.</a></h1>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Jan 28, 2018</h4>

            <article class="post">
                <h2 class="title">
                    <a href="./pandas.html" rel="bookmark" title="Permanent Link to &quot;Pandas&quot;">Pandas</a>
                </h2>

                <h4>Useful Links</h4>
<ul>
<li><a href="https://pbpython.com/sidetable.html">Sidetable - Create Summary Tables</a></li>
<li><a href="https://deepnote.com/article/sidetable-pandas-methods-you-didnt-know-you-needed">Sidetable Gives You the Pandas Methods You Didn't Know You Needed</a></li>
<li><a href="https://dfrieds.com/data-analysis/crosstabs-python-pandas.html">crosstabs() Method: Compute Aggregated Metrics Across Categorical Columns</a></li>
<li><a href="https://towardsdatascience.com/automate-boring-tasks-with-your-own-functions-a32785437179">7 Simple Python Functions to Clean Your Data</a></li>
</ul>
<h3>Imports</h3>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas_profiling</span> <span class="kn">import</span> <span class="n">ProfileReport</span> 

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_colwidth&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>


<h3>IO</h3>
<h4>Read CSV</h4>
<div class="highlight"><pre><span></span><span class="n">fp</span> <span class="o">=</span> <span class="s1">&#39;../local-data/data.csv&#39;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span>
                 <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                 <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">,</span> <span class="c1"># to prevent unicode error</span>
                 <span class="n">keep_default_na</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">dayfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="c1">#infer_datetime_format=True,</span>
                 <span class="n">parse_dates</span> <span class="o">=</span> <span class="n">date_cols</span><span class="p">)</span>
</pre></div>


<h4>Read XLS</h4>
<div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s2">&quot;../local-data/file.xlsx&quot;</span><span class="p">,</span> 
                  <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                  <span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">,</span>
                  <span class="n">skiprows</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> 
                  <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">skip_footer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                  <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="n">sheet_name</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>


<h4>Read tsv.gz</h4>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bz2</span> <span class="kn">import</span> <span class="n">BZ2File</span> <span class="k">as</span> <span class="n">bzopen</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;STRING_triples.tsv.gz&#39;</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">,</span>
           <span class="n">error_bad_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">bzopen</span><span class="p">(</span><span class="s2">&quot;STRING_context-restricted.tsv.bz2&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">bzfin</span><span class="p">:</span>
<span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bzfin</span><span class="p">):</span>
    <span class="c1"># if i == 10000: break</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
</pre></div>


<h4>Read Multiple Files in Directory</h4>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span>
<span class="n">li</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># add dataframes to this list</span>
<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;../local-data/original/new&#39;</span>
<span class="n">all_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/*&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">all_files</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> 
                  <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                  <span class="n">encoding</span> <span class="o">=</span> <span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">li</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">tmp</span>

<span class="c1"># make a dataframe of all the files combined</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">li</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>


<h4>Read Multiple files in ZipFile</h4>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="k">for</span> <span class="n">text_file</span> <span class="ow">in</span> <span class="n">zip_file</span><span class="o">.</span><span class="n">infolist</span><span class="p">():</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">zip_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">text_file</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">to_html</span><span class="p">()))</span>
</pre></div>


<h4><a href="https://stackoverflow.com/questions/33952142/prevent-pandas-from-interpreting-na-as-nan-in-a-string">Prevent pandas from interpreting 'NA' as NaN in a string</a></h4>
<div class="highlight"><pre><span></span>df = pd.read_csv(  &#39;parsed_json.csv&#39;
                 , dtype=str
                 , na_filter = False)
</pre></div>


<h4>Write</h4>
<p><code>df.to_csv("../local-data/output/shuba_data_subset.csv", index=True)</code></p>
<h3>Pickle</h3>
<div class="highlight"><pre><span></span># save as pickle
f = open(&#39;../local-data/input/filename.pickle&#39;, &#39;wb&#39;)
pickle.dump(df, f)
f.close()

# read pickle
df = pd.read_pickle(&#39;../local-data/input/filename.pickle&#39;)
print(df.shape)
df.head(1)
</pre></div>


<h3>Combine Train / Test</h3>
<div class="highlight"><pre><span></span>fp_tr = &quot;../local-data/input/train.csv&quot;
fp_te = &quot;../local-data/input/test.csv&quot;

train = pd.read_csv(fp_tr)
test = pd.read_csv(fp_te)

dat =  pd.concat(objs=[train, test], axis=0).reset_index(drop=True)
TestPassengerID = test[&#39;PassengerId&#39;]
dat.shape
</pre></div>


<h3>Handling Dates</h3>
<h4>Convert Date String</h4>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;colname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;colname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">))</span>
</pre></div>


<h4>Filling missing dates and values within group</h4>
<div class="highlight"><pre><span></span># gpd[&#39;Date&#39;] = pd.to_datetime(gpd[&#39;Date&#39;])
gpd = \
gpd.set_index(
    [&#39;Date&#39;, &#39;Verktitel&#39;]
).unstack(
    fill_value=0
).asfreq(
    &#39;MS&#39;, fill_value=0
).stack().sort_index(level=1).reset_index()
gpd.head()
</pre></div>


<h4>Create Date Features</h4>
<div class="highlight"><pre><span></span><span class="c1"># time conversion helper variables</span>
<span class="n">seconds_in_day</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span>
<span class="n">seconds_in_hour</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>

<span class="c1"># Create new feature: Resolution Time</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;resolution_time_secs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">resolved_at</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">opened_at</span>

<span class="c1"># convert to seconds</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;resolution_time_secs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;resolution_time_secs&#39;</span><span class="p">]</span>
                                <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>

<span class="c1"># convert resolution time to days</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;resolution_time_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;resolution_time_secs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;resolution_time_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;resolution_time_days&#39;</span><span class="p">]</span>
                                <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">//</span> <span class="n">seconds_in_day</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

<span class="c1"># convert resolution time to hours</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;resolution_time_hrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;resolution_time_secs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;resolution_time_hrs&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;resolution_time_hrs&#39;</span><span class="p">]</span>
                              <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">//</span> <span class="n">seconds_in_hour</span><span class="p">))</span>
</pre></div>


<h4>Select by Year</h4>
<div class="highlight"><pre><span></span>data = data[data.opened_at.dt.year &gt;= 2019]
</pre></div>


<h4>Replace</h4>
<ul>
<li><code>df = df.replace(r'\s+', np.nan, regex=True).replace('', np.nan)</code></li>
<li><code>df = df.replace(to_replace=np.nan, value="NULL")</code></li>
<li><code>df = df.replace(to_replace="", value="unknown").replace(to_replace=np.nan, value="unknown")</code></li>
</ul>
<h3>Column subset</h3>
<p><code>df = df[['col1', 'col2', ...]]</code></p>
<h3>Inspect</h3>
<h4>Duplicate rows</h4>
<p>(see here)[https://thispointer.com/pandas-find-duplicate-rows-in-a-dataframe-based-on-all-or-selected-columns-using-dataframe-duplicated-in-python/#:~:text=To%20find%20%26%20select%20the%20duplicate,argument%20is%20'first').]</p>
<div class="highlight"><pre><span></span># Select all duplicate rows based on all columns
df[df.duplicated(keep=False)]
</pre></div>


<div class="highlight"><pre><span></span># Select all duplicate rows based on one column
df[df.duplicated([&#39;col_name&#39;])]
</pre></div>


<p><code>df[df.duplicated(['col_name'], keep=False)].sort_values(by='col_name')</code></p>
<h4>Duplicates in a column</h4>
<div class="highlight"><pre><span></span>ids = df[&quot;col_name&quot;]
df[ids.isin(ids[ids.duplicated()])].sort_values(by=&quot;col_name&quot;)
</pre></div>


<h4>Count missing values</h4>
<div class="highlight"><pre><span></span><span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">missing</span> <span class="o">=</span> <span class="p">(</span><span class="n">missing</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;cnt&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;cnt&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">missing</span><span class="p">[</span><span class="n">missing</span><span class="p">[</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
</pre></div>


<p>or</p>
<div class="highlight"><pre><span></span><span class="n">num_avg_rel_isnan</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;avg_relevance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="err">`</span>
</pre></div>


<h3>Create new columns</h3>
<h3>Expand Column</h3>
<p><code>df[['TRID','SRC','RID', 'TESTTIME']] = df.ID.str.split('_', expand=True)</code></p>
<h4>Create columns from row with same ID</h4>
<div class="highlight"><pre><span></span># get duplicates
tmp = df[df.duplicated([&#39;IncidentNumber&#39;], keep=False)].sort_values(by=&#39;IncidentNumber&#39;)
# create new colums
tmp = (tmp.set_index([&#39;IncidentNumber&#39;, tmp.groupby([&#39;IncidentNumber&#39;])
                      .cumcount()])[[&#39;Comments&#39;, &#39;GoodServiceRecoveryEstimate&#39;]]
         .unstack(fill_value=&#39;&#39;)
         .add_prefix(&#39;&#39;)
      )
print(len(tmp))

# flatten multiindex column headers
tmp.columns = tmp.columns.map(&#39;_&#39;.join)
tmp 
</pre></div>


<h3>Drop</h3>
<ul>
<li><code>df.drop(df.columns[0], axis=1, inplace=True)</code> # drop column by index</li>
<li><code>df = df[df.index.notna()]</code> # Drop rows if index is NA</li>
<li><code>df = df[df.col_name.notna()]</code> # Drop rows if value in a specific column is NA</li>
</ul>
<h3>Consolidate Column Levels</h3>
<h4>to prevent <code>SettingWithCopyWarning</code></h4>
<div class="highlight"><pre><span></span><span class="n">kw</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Email&#39;</span><span class="p">,</span> <span class="s1">&#39;Phone&#39;</span><span class="p">,</span> <span class="s1">&#39;Self-service&#39;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;category2&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">kw</span><span class="p">),</span> 
                                         <span class="n">df</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> 
                                         <span class="s1">&#39;Other&#39;</span><span class="p">)}))</span>
</pre></div>


<h4>with <code>apply</code></h4>
<div class="highlight"><pre><span></span><span class="n">kw</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Email&#39;</span><span class="p">,</span> <span class="s1">&#39;Phone&#39;</span><span class="p">,</span> <span class="s1">&#39;Self-service&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_type2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">contact_type</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span>
                                              <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">k</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">])</span>
                                              <span class="k">else</span> <span class="s1">&#39;Other&#39;</span><span class="p">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">contact_type2</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>


<h3>Fill Missing</h3>
<h4>Fill missing values with median</h4>
<div class="highlight"><pre><span></span># fill the missing values of Fare
test_df[&#39;Fare&#39;].fillna(test_df[&#39;Fare&#39;].dropna().median(), inplace=True)
</pre></div>


<h3>Replace values</h3>
<h4>Replacing values in a column</h4>
<p><code>df['female'] = df['female'].replace({'female': 1, 'male': 0})</code></p>
<h4>Replace NA with 'Other'</h4>
<div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;Other&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>


<h5>Replace empty string with NA then drop NA's</h5>
<div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> 
<span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre></div>


<h4>Replace True/False by 1/0</h4>
<p>use <code>astype(int)</code> to convert values to 0 and 1</p>
<p><code>df['new_col'] = df['B'].isin([3, 2]).astype(int)</code></p>
<h3>Create New Feature</h3>
<h4>Create a boolean feature column</h4>
<div class="highlight"><pre><span></span><span class="nv">data</span>[<span class="s1">&#39;</span><span class="s">is_WE</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="ss">(</span><span class="nv">data</span>.<span class="nv">opened_at</span>.<span class="nv">apply</span><span class="ss">(</span><span class="nv">lambda</span> <span class="nv">x</span> : <span class="mi">1</span> 
                                      <span class="k">if</span> <span class="nv">x</span>.<span class="nv">strftime</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">%A</span><span class="s1">&#39;</span><span class="ss">)</span> <span class="nv">in</span>[<span class="s1">&#39;</span><span class="s">Saturday</span><span class="s1">&#39;</span>, <span class="s1">&#39;</span><span class="s">Sunday</span><span class="s1">&#39;</span>]
                                      <span class="k">else</span> <span class="mi">0</span><span class="ss">))</span>.<span class="nv">astype</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">category</span><span class="s1">&#39;</span><span class="ss">)</span>
</pre></div>


<p>or...using shizen-gengo text search</p>
<div class="highlight"><pre><span></span>data[&#39;is_costa&#39;] = 0
costa_inc_nbrs = explore_utils.search(data, &#39;description&#39;, &#39;costa&#39;).reset_index().number
data.loc[costa_inc_nbrs.tolist(), &#39;is_costa&#39;] = 1
len(data[data.is_costa==1])
</pre></div>


<h4>Add column with new value based on values in other cols:</h4>
<div class="highlight"><pre><span></span>conditions = [(data.company == &#39;unknown&#39;) &amp;  (data.is_costa == 1)]
outputs = [&#39;costa&#39;]
data.company = np.select(conditions, outputs, default=data.company)
</pre></div>


<h3>Merge</h3>
<h4>Stack the DataFrames on top of each other</h4>
<p><code>vertical_stack = pd.concat([survey_sub, survey_sub_last10], axis=0)</code></p>
<h4>Place the DataFrames side by side</h4>
<p><code>horizontal_stack = pd.concat([survey_sub, survey_sub_last10], axis=1)</code></p>
<h4>Merge on index</h4>
<div class="highlight"><pre><span></span><span class="c1"># make sure that both indexes are of the same type</span>
<span class="n">df1</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df2</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                <span class="n">suffixes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_x&#39;</span><span class="p">,</span> <span class="s1">&#39;_y&#39;</span><span class="p">],</span>
                <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>


<h3>groupby</h3>
<h4>generic groupby</h4>
<div class="highlight"><pre><span></span><span class="err">(</span><span class="nf">df</span><span class="p">[[</span><span class="err">&#39;</span><span class="no">FamilySize</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="no">Survived</span><span class="err">&#39;</span><span class="p">]]</span>
<span class="na">.groupby</span><span class="p">([</span><span class="err">&#39;</span><span class="no">FamilySize</span><span class="err">&#39;</span><span class="p">],</span> <span class="no">as_index</span><span class="err">=</span><span class="no">False</span><span class="p">)</span>
 <span class="na">.mean</span><span class="p">()</span>
 <span class="na">.sort_values</span><span class="p">(</span><span class="no">by</span><span class="err">=&#39;</span><span class="no">Survived</span><span class="err">&#39;</span><span class="p">,</span> <span class="no">ascending</span><span class="err">=</span><span class="no">False</span><span class="p">))</span>
</pre></div>


<h4>groupby and sum two columns</h4>
<div class="highlight"><pre><span></span>gpd = (df.groupby([&#39;Date&#39;, &#39;Verktitel&#39;])[[&#39;Belopp&#39;, &#39;Antal Spelningar&#39;]]
       .agg({&#39;Belopp&#39; : sum, &#39;Antal Spelningar&#39; : sum})
      )
gpd = gpd.reset_index()
gpd.head()
</pre></div>


<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;caller&#39;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">size</span><span class="p">()</span>
 <span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
 <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s1">&#39;cnt&#39;</span><span class="p">})</span>
 <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;cnt&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<h4>groupby with dates</h4>
<div class="highlight"><pre><span></span>tmp.groupby(tmp[&#39;opened_at&#39;])[&#39;number&#39;]
         .size()
         .reset_index(name=&#39;cnt&#39;)
         .sort_values(by=[&#39;opened_at&#39;, &#39;cnt&#39;], ascending=[True, False]
</pre></div>


<h4>Adding counts from a groupby(): mapping with a dict</h4>
<div class="highlight"><pre><span></span><span class="n">gpd</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="o">...</span>
<span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gpd</span><span class="o">.</span><span class="n">caller</span><span class="p">,</span> <span class="n">gpd</span><span class="o">.</span><span class="n">cnt</span><span class="p">))</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;nbr_tickets_opened&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">customer_display_name</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<h3>Melt &amp; Pivot</h3>
<ul>
<li><code>gpd.pivot(index='Date', columns='Verktitel', values='Belopp')</code></li>
<li><code>tmp = tmp.melt('Date', var_name='cols',  value_name='vals')</code></li>
</ul>
<h4>Compute ratio from a binary split for each UID</h4>
<div class="highlight"><pre><span></span>gpd = (df.groupby([&#39;v_incident_uid&#39;, &#39;Incident Number&#39;, &#39;v_role&#39;])[&#39;v_role&#39;]
 .size()
 .to_frame()
 .rename(columns={&#39;v_role&#39;:&#39;cnt&#39;})
).reset_index()

gpd = gpd.pivot(index=&#39;v_incident_uid&#39;, columns=&#39;v_role&#39;, values=&#39;cnt&#39;)
gpd[&#39;ratio&#39;] = (gpd.Primary / (gpd.Primary + gpd.Reactionary)).round(2)
gpd.reset_index(inplace=True)
</pre></div>


<h3>Selecting Data</h3>
<h4>List of column names to select</h4>
<div class="highlight"><pre><span></span>cols = [&#39;colname1&#39;, &#39;colname2]
df = df2.loc[:, cols]
</pre></div>


<h4>Conditional search</h4>
<div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">df_co_occurrences</span><span class="p">[</span>
    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_co_occurrences</span><span class="o">.</span><span class="n">ent_a</span> <span class="o">==</span> <span class="s1">&#39;4040&#39;</span><span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_co_occurrences</span><span class="o">.</span><span class="n">ent_b</span> <span class="o">==</span> <span class="s1">&#39;5267&#39;</span><span class="p">)]</span>
</pre></div>


<h4>Get two columns for a specific row</h4>
<p><code>embeddings_df.ix[[input_entity_uri]][['transformed_x', 'transformed_y']]</code></p>
<h4>Find rows by column index and with condition</h4>
<p><code>assign_clusters_df[assign_clusters_df[1]==2]</code></p>
<h4>Select with <code>iloc</code> or <code>loc</code></h4>
<p>iloc</p>
<p><code>if embeddings_df.iloc[row_id].name == input_entity_uri</code></p>
<p>loc</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_pmi</span><span class="p">(</span><span class="n">ent_ab</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">count_ab</span><span class="p">,</span> <span class="n">ent_a_count</span><span class="p">,</span> <span class="n">ent_b_count</span><span class="p">):</span>
    <span class="n">count_ab</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ent_ab&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ent_ab</span><span class="p">,</span> <span class="s1">&#39;count_ab&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ent_a_count</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ent_ab&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ent_ab</span><span class="p">,</span> <span class="s1">&#39;ent_a_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ent_b_count</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ent_ab&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ent_ab</span><span class="p">,</span> <span class="s1">&#39;ent_b_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">count_ab</span> <span class="o">/</span> <span class="p">(</span><span class="n">ent_a_count</span> <span class="o">*</span> <span class="n">ent_b_count</span><span class="p">)</span>   
</pre></div>


<h4>Select based on regexp: <code>str.contains()</code></h4>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;(?i)gps&quot;</span><span class="p">)]</span>
</pre></div>


<h4>Select based on Frequency threshold</h4>
<div class="highlight"><pre><span></span><span class="n">freq_cat</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">freq_cat</span> <span class="o">=</span> <span class="n">freq_cat</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;pct&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">freq_cat</span> <span class="o">=</span> <span class="n">freq_cat</span><span class="p">[</span><span class="n">freq_cat</span><span class="o">.</span><span class="n">pct</span><span class="o">&gt;=</span><span class="n">t</span><span class="p">]</span>
</pre></div>


<h3>Drop / Remove Data</h3>
<h4>Remove elements from a lookup list</h4>
<p><code>df = df[~df.uri.isin(list_cluster_entities)]</code></p>
<h4>Drop any NaN in any column</h4>
<p><code>embeddings_bio_df = embeddings_df[~embeddings_df.isin(['NaN']).any(axis=1)]</code></p>
<h4>Drop a spcific column</h4>
<p><code>neighbors_df = neighbors_df.drop('uri.1', 1)</code></p>
<h3>Sorting</h3>
<h4>Sort a column by the values in another</h4>
<div class="highlight"><pre><span></span><span class="n">df_typed</span><span class="p">[</span><span class="s1">&#39;rank_avg_relevance&#39;</span><span class="p">]</span> <span class="o">=</span>
    <span class="n">df_typed</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;source_tsne&#39;</span><span class="p">)[</span><span class="s1">&#39;avg_relevance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>


<p>or</p>
<p><code>mentionList = sorted(tuple(mentionList), key=lambda x: x[1])</code></p>
<p>source: <a href="http://stackoverflow.com/questions/20183069/how-to-sort-multidimensional-array-by-column">How to sort multidimensional array by column?</a></p>
<h3>Concatenate rows from multiple files into one DF</h3>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">input_eval_dp</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_eval_dp</span><span class="p">)</span>

    <span class="c1"># add all scores from the various files to one DF</span>
    <span class="n">eval_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_eval_dp</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

        <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">get_eval</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">eval_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">eval_df</span><span class="p">,</span> <span class="n">tmp_df</span><span class="p">])</span>
        <span class="c1"># print(eval_df.shape)</span>
    <span class="c1"># print(eval_df.head())</span>
    <span class="k">return</span> <span class="n">eval_df</span>
</pre></div>


<h3>Zero Variance: Exclude columns with only one level</h3>
<div class="highlight"><pre><span></span><span class="n">criteria</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_final</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()[</span><span class="s1">&#39;unique&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
<span class="n">criteria</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">df_final</span> <span class="o">=</span> <span class="n">df_final</span><span class="p">[</span><span class="n">df_final</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">criteria</span><span class="p">]]</span>
<span class="n">df_final</span><span class="o">.</span><span class="n">shape</span>
</pre></div>


<p>or</p>
<div class="highlight"><pre><span></span><span class="n">nunique</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">nunique</span><span class="p">)</span>
<span class="n">cols_to_drop</span> <span class="o">=</span> <span class="n">nunique</span><span class="p">[</span><span class="n">nunique</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cols_to_drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>


<p>or, based on standard deviation</p>
<div class="highlight"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">cols_to_drop</span> <span class="o">=</span> <span class="n">std</span><span class="p">[</span><span class="n">std</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cols_to_drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<h3>np.where</h3>
<h4>np.where()</h4>
<div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_fujitsu_owned&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;resolvergroup1&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Fujitsu&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_fujitsu_owned&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>


<h1>np.where with multipe conditions / choices</h1>
<div class="highlight"><pre><span></span><span class="n">col</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;consumption_energy&#39;</span><span class="w"></span>
<span class="n">conditions</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n"> df2[col</span><span class="o">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">df2</span><span class="o">[</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">400</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">df2</span><span class="o">[</span><span class="n">col</span><span class="o">]&gt;</span><span class="w"> </span><span class="mi">200</span><span class="p">),</span><span class="w"> </span><span class="n">df2</span><span class="o">[</span><span class="n">col</span><span class="o">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="err">]</span><span class="w"></span>
<span class="n">choices</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n"> &quot;high&quot;, &#39;medium&#39;, &#39;low&#39; </span><span class="o">]</span><span class="w"></span>
<span class="n">df2</span><span class="o">[</span><span class="n">&quot;energy_class&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="k">default</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">)</span><span class="w"></span>
</pre></div>


<h3>Misc.</h3>
<h4>Add Delta column</h4>
<div class="highlight"><pre><span></span>MENTZ = pd.to_datetime(df[&#39;DUE_MENTZ&#39;].astype(str))
DB = pd.to_datetime(df[&#39;DUE_DB&#39;].astype(str))
df[&#39;DELTA(MINS)&#39;] = MENTZ.sub(DB).dt.total_seconds().div(60).round()
</pre></div>


<h4>Create sample dataset</h4>
<div class="highlight"><pre><span></span>tmp = df.sample(10000)
tmp.to_csv(&quot;../local-data/output/bat_sample2_original_headers.csv&quot;, index=False)
del tmp
</pre></div>


<h4>Get quick proportions</h4>
<p><code>df['is_pw_reset'].value_counts(normalize=True)</code></p>
<h4>Prevent line break when printing list</h4>
<p><code>print(sorted( set(dat.category.unique()) ), end='')</code></p>
<h4>Convert to Categorical dtype</h4>
<p><code>df['contact_type'] = df['contact_type'].astype("category")</code></p>
<h4>Dataframe to List</h4>
<p>Convert dataframe column to list</p>
<p><code>entity_list = entity_list_df['uri'].tolist()</code></p>
<p>Create one big list of ID's from two DF columns that contain IDs</p>
<div class="highlight"><pre><span></span><span class="n">triples</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ix</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
<span class="n">phosphonetowrk_IDs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">triples</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
</pre></div>


<h4>Working with Tuples</h4>
<div class="highlight"><pre><span></span><span class="n">phrases_df</span> <span class="o">=</span> <span class="n">phrases_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;(a,a)&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">phrases_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">phrases_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>  <span class="o">=</span> <span class="n">phrases_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">phrases_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<p>or</p>
<div class="highlight"><pre><span></span><span class="n">phrases</span> <span class="o">=</span> <span class="n">phrases</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;(,)&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">phrases</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">phrases</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">phrases</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                         <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
<span class="n">phrases</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<h4>Crosstab</h4>
<div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Russian Federation&#39;</span><span class="p">])]</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">bat_5tc_service</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="c1"># ROWS</span>
                  <span class="n">df</span><span class="o">.</span><span class="n">country</span><span class="p">,</span>                     <span class="c1"># COLS</span>
                  <span class="n">values</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">incident_id</span><span class="p">,</span> 
                  <span class="n">aggfunc</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">nunique</span><span class="p">,</span>
                  <span class="n">margins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="c1">#.fillna(value=0)</span>
<span class="n">tmp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">to_records</span><span class="p">())</span> <span class="c1"># flatten</span>
</pre></div>


<div class="highlight"><pre><span></span># with percentages
pd.crosstab(df.FamilySize, # ROWS
              df.Survived, # COLS
              values=df.PassengerId, 
              aggfunc=pd.Series.nunique,
              normalize=&#39;index&#39;,
              dropna=False).round(2)
</pre></div>


<h3>Links to review</h3>
<ul>
<li><a href="https://www.shanelynn.ie/select-pandas-dataframe-rows-and-columns-using-iloc-loc-and-ix/">Using iloc, loc, &amp; ix to select rows and columns in Pandas DataFrames</a></li>
<li><a href="https://towardsdatascience.com/a-really-simple-way-to-edit-row-by-row-in-a-pandas-dataframe-75d339cbd313">A Really Simple Way to Edit Row by Row in a Pandas DataFrame</a></li>
<li><a href="https://towardsdatascience.com/how-to-use-multiindex-in-pandas-to-level-up-your-analysis-aeac7f451fce">How to Use MultiIndex in Pandas</a></li>
</ul>
                <div class="clear"></div>

                <div class="info">
                    <a href="./pandas.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="./category/python.html" rel="tag">Python</a>
                </div>
            </article>            <h4 class="date">Jan 27, 2018</h4>

            <article class="post">
                <h2 class="title">
                    <a href="./pandas_regexp.html" rel="bookmark" title="Permanent Link to &quot;Pandas Regular Expressions&quot;">Pandas Regular Expressions</a>
                </h2>

                <h4>Extract Substring</h4>
<div class="highlight"><pre><span></span># obtain Title from name (Mr, Mrs, Miss etc) by extracting up to but excluding the first dot (.)
df[&#39;Title&#39;] = df.Name.str.extract(&#39; ([A-Za-z]+)\.&#39;, expand=False)
</pre></div>


<h4>String Matching</h4>
<div class="highlight"><pre><span></span><span class="n">col</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;category&#39;</span><span class="w"></span>
<span class="n">conditions</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">(tmp[col</span><span class="o">]</span><span class="p">.</span><span class="nf">str</span><span class="p">.</span><span class="k">contains</span><span class="p">(</span><span class="ss">&quot;(?i)ISD&quot;</span><span class="p">)),</span><span class="w"></span>
<span class="w">               </span><span class="p">(</span><span class="n">tmp</span><span class="o">[</span><span class="n">col</span><span class="o">]</span><span class="p">.</span><span class="nf">str</span><span class="p">.</span><span class="k">contains</span><span class="p">(</span><span class="ss">&quot;(?i)DST&quot;</span><span class="p">)),</span><span class="w"></span>
<span class="w">               </span><span class="n">tmp</span><span class="o">[</span><span class="n">col</span><span class="o">]</span><span class="p">.</span><span class="nf">str</span><span class="p">.</span><span class="k">contains</span><span class="p">(</span><span class="ss">&quot;(?i)IT&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">              </span><span class="err">]</span><span class="w"></span>
<span class="n">choices</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">&#39;ISD&#39;, &#39;DST&#39;, &#39;IT&#39;</span><span class="o">]</span><span class="w"></span>

<span class="n">tmp</span><span class="o">[</span><span class="n">&quot;category_high_level&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="k">select</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span><span class="w"> </span><span class="n">choices</span><span class="p">,</span><span class="w"> </span><span class="k">default</span><span class="o">=</span><span class="n">tmp</span><span class="p">.</span><span class="n">category</span><span class="p">)</span><span class="w"></span>
<span class="n">tmp</span><span class="p">.</span><span class="n">stb</span><span class="p">.</span><span class="n">freq</span><span class="p">(</span><span class="o">[</span><span class="n">&#39;category_high_level&#39;</span><span class="o">]</span><span class="p">).</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;category_high_level&#39;</span><span class="p">)</span><span class="w"></span>
</pre></div>
                <div class="clear"></div>

                <div class="info">
                    <a href="./pandas_regexp.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="./category/python.html" rel="tag">Python</a>
                </div>
            </article>

                <div class="clear"></div>
                <div class="pages">

                    <a href="./page/2" class="prev_page">&larr;&nbsp;Previous</a>
                    <a href="./page/4" class="next_page">Next&nbsp;&rarr;</a>
                    <span>Page 3 of 21</span>
                </div>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Powered by <a href="http://getpelican.com">Pelican</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
</body>
</html>